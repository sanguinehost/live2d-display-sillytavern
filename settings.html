<!-- Live2D Display Extension Settings -->
<div class="live2d-settings">
  <h3>üé≠ Live2D Display Settings</h3>

  <!-- Enable Extension -->
  <div class="live2d-setting-row">
    <label>
      <input type="checkbox" id="live2d-enabled" checked />
      Enable Extension
    </label>
  </div>

  <!-- Show Live2D -->
  <div class="live2d-setting-row">
    <label>
      <input type="checkbox" id="live2d-show" checked />
      Show Live2D Model
    </label>
  </div>

  <!-- Enable Expressions -->
  <div class="live2d-setting-row">
    <label>
      <input type="checkbox" id="live2d-expressions" checked />
      Auto Expressions
    </label>
  </div>

  <!-- Enable Idle Animation -->
  <div class="live2d-setting-row">
    <label>
      <input type="checkbox" id="live2d-idle" checked />
      Idle Animation
    </label>
  </div>

  <!-- Hide on Mobile -->
  <div class="live2d-setting-row">
    <label>
      <input type="checkbox" id="live2d-hide-mobile" checked />
      Hide on Mobile
    </label>
  </div>

  <hr style="margin: 1.5rem 0; border-color: var(--SmartThemeBorderColor, #444);" />

  <!-- Model Scale -->
  <div class="live2d-setting-row">
    <label>
      Model Scale:
      <input
        type="range"
        id="live2d-scale"
        min="0.1"
        max="2"
        step="0.1"
        value="0.5"
      />
      <input type="number" id="live2d-scale-value" min="0.1" max="2" step="0.1" value="0.5" />
    </label>
  </div>

  <!-- Position X -->
  <div class="live2d-setting-row">
    <label>
      Position X:
      <input
        type="range"
        id="live2d-x"
        min="0"
        max="800"
        step="10"
        value="200"
      />
      <input type="number" id="live2d-x-value" min="0" max="800" step="10" value="200" />
    </label>
  </div>

  <!-- Position Y -->
  <div class="live2d-setting-row">
    <label>
      Position Y:
      <input
        type="range"
        id="live2d-y"
        min="0"
        max="1200"
        step="10"
        value="300"
      />
      <input type="number" id="live2d-y-value" min="0" max="1200" step="10" value="300" />
    </label>
  </div>

  <!-- Quality -->
  <div class="live2d-setting-row">
    <label>
      Quality:
      <select id="live2d-quality">
        <option value="high">High (60 FPS)</option>
        <option value="medium">Medium (30 FPS)</option>
        <option value="low">Low (24 FPS)</option>
      </select>
    </label>
  </div>

  <hr style="margin: 1.5rem 0; border-color: var(--SmartThemeBorderColor, #444);" />

  <!-- Model Path Section -->
  <div class="live2d-upload-section">
    <h4>üìÅ Character Model</h4>
    <p>Specify the path to the Live2D model for the current character.</p>

    <div class="live2d-model-info" id="live2d-model-info">
      <p><strong>Current Character:</strong> <span id="live2d-current-character">None selected</span></p>
      <p><strong>Model Path:</strong></p>
      <input
        type="text"
        id="live2d-model-path"
        class="text_pole"
        placeholder="models/simple/simple.model3.json"
        style="width: 100%; margin-bottom: 10px;"
      />
      <small style="color: var(--SmartThemeQuoteColor, #999);">
        Path relative to extension directory (e.g., <code>models/simple/simple.model3.json</code>)
      </small>

      <div style="margin-top: 10px;">
        <button type="button" class="live2d-button" id="live2d-save-model-btn">
          üíæ Save Model Path
        </button>
        <button type="button" class="live2d-button danger" id="live2d-remove-btn">
          üóëÔ∏è Remove Model
        </button>
        <button type="button" class="live2d-button" id="live2d-reload-btn">
          üîÑ Reload Model
        </button>
      </div>
    </div>
  </div>

  <!-- Instructions -->
  <div class="live2d-instructions">
    <h4>‚ÑπÔ∏è How to Use</h4>
    <ol>
      <li><strong>Get a Live2D model</strong> (Cubism 2.1 or 4.0 format)</li>
      <li><strong>Place the model folder</strong> in <code>SillyTavern/public/scripts/extensions/third-party/live2d-display-sillytavern/models/</code>
        <br>
        <small style="color: var(--SmartThemeQuoteColor, #999);">
          Example: Place "simple" folder so the structure is:<br>
          <code>live2d-display-sillytavern/models/simple/simple.model3.json</code>
        </small>
      </li>
      <li><strong>Select a character</strong> in SillyTavern</li>
      <li><strong>Enter the model path</strong> above (e.g., <code>models/simple/simple.model3.json</code>)</li>
      <li><strong>Click "Save Model Path"</strong> - the model will load automatically</li>
    </ol>

    <h4 style="margin-top: 1rem;">üì¶ Model Requirements</h4>
    <ul>
      <li><code>.model3.json</code> (or <code>.model.json</code> for Cubism 2)</li>
      <li><code>.moc3</code> file (model data)</li>
      <li>Texture images (<code>.png</code>)</li>
      <li>Motion files (<code>.motion3.json</code>)</li>
      <li>Expression files (<code>.exp3.json</code>, optional)</li>
    </ul>

    <h4 style="margin-top: 1rem;">üé≠ Expression Mapping</h4>
    <p>The extension automatically detects emotions in AI messages:</p>
    <ul>
      <li><strong>Happy:</strong> happy, joy, laugh, smile, cheerful</li>
      <li><strong>Sad:</strong> sad, cry, tear, sorrow, upset</li>
      <li><strong>Angry:</strong> angry, mad, furious, rage, annoyed</li>
      <li><strong>Surprised:</strong> surprise, shock, amaze, wow</li>
      <li><strong>Fear:</strong> fear, scared, afraid, terrified</li>
    </ul>
  </div>
</div>

<script>
  // Settings UI logic
  jQuery(() => {
    const Live2D = window.Live2DDisplay;
    if (!Live2D) {
      console.error('[Live2D Settings] Extension API not available');
      return;
    }

    const settings = Live2D.getSettings();

    // Load initial values
    $('#live2d-enabled').prop('checked', settings.enabled);
    $('#live2d-show').prop('checked', settings.showLive2D);
    $('#live2d-expressions').prop('checked', settings.enableExpressions);
    $('#live2d-idle').prop('checked', settings.enableIdleAnimation);
    $('#live2d-hide-mobile').prop('checked', settings.hideMobile);
    $('#live2d-scale').val(settings.modelScale);
    $('#live2d-scale-value').val(settings.modelScale);
    $('#live2d-x').val(settings.modelX);
    $('#live2d-x-value').val(settings.modelX);
    $('#live2d-y').val(settings.modelY);
    $('#live2d-y-value').val(settings.modelY);
    $('#live2d-quality').val(settings.quality);

    // Event listeners
    $('#live2d-enabled').on('change', (e) => {
      Live2D.updateSetting('enabled', e.target.checked);
    });

    $('#live2d-show').on('change', (e) => {
      Live2D.updateSetting('showLive2D', e.target.checked);
    });

    $('#live2d-expressions').on('change', (e) => {
      Live2D.updateSetting('enableExpressions', e.target.checked);
    });

    $('#live2d-idle').on('change', (e) => {
      Live2D.updateSetting('enableIdleAnimation', e.target.checked);
    });

    $('#live2d-hide-mobile').on('change', (e) => {
      Live2D.updateSetting('hideMobile', e.target.checked);
    });

    // Scale slider
    $('#live2d-scale').on('input', (e) => {
      const value = parseFloat(e.target.value);
      $('#live2d-scale-value').val(value);
      Live2D.updateSetting('modelScale', value);
    });

    $('#live2d-scale-value').on('change', (e) => {
      const value = parseFloat(e.target.value);
      $('#live2d-scale').val(value);
      Live2D.updateSetting('modelScale', value);
    });

    // Position X slider
    $('#live2d-x').on('input', (e) => {
      const value = parseInt(e.target.value);
      $('#live2d-x-value').val(value);
      Live2D.updateSetting('modelX', value);
    });

    $('#live2d-x-value').on('change', (e) => {
      const value = parseInt(e.target.value);
      $('#live2d-x').val(value);
      Live2D.updateSetting('modelX', value);
    });

    // Position Y slider
    $('#live2d-y').on('input', (e) => {
      const value = parseInt(e.target.value);
      $('#live2d-y-value').val(value);
      Live2D.updateSetting('modelY', value);
    });

    $('#live2d-y-value').on('change', (e) => {
      const value = parseInt(e.target.value);
      $('#live2d-y').val(value);
      Live2D.updateSetting('modelY', value);
    });

    // Quality select
    $('#live2d-quality').on('change', (e) => {
      Live2D.updateSetting('quality', e.target.value);
    });

    // Update current character name
    function updateCurrentCharacter() {
      try {
        const context = window.getContext?.();
        if (context && context.characters && context.characterId !== undefined) {
          const character = context.characters[context.characterId];
          if (character) {
            $('#live2d-current-character').text(character.name || 'Unknown');

            // Load current model path if exists
            const modelPath = character.data?.live2d_model_path || '';
            $('#live2d-model-path').val(modelPath);
          }
        }
      } catch (error) {
        console.error('[Live2D] Error updating character:', error);
      }
    }

    // Update character info on settings open
    updateCurrentCharacter();

    // Save model path button
    $('#live2d-save-model-btn').on('click', () => {
      const modelPath = $('#live2d-model-path').val()?.trim();
      if (!modelPath) {
        alert('Please enter a model path');
        return;
      }

      if (Live2D.saveModelPath) {
        Live2D.saveModelPath(modelPath);
        toastr.success('Model path saved. Loading model...', 'Live2D Display');
      }
    });

    // Remove button
    $('#live2d-remove-btn').on('click', () => {
      if (confirm('Remove Live2D model from this character?')) {
        $('#live2d-model-path').val('');
        if (Live2D.saveModelPath) {
          Live2D.saveModelPath('');
          toastr.info('Model removed from character', 'Live2D Display');
        }
      }
    });

    // Reload button
    $('#live2d-reload-btn').on('click', () => {
      Live2D.loadCurrentCharacterModel();
      toastr.info('Reloading model...', 'Live2D Display');
    });
  });
</script>
